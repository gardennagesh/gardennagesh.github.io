<p>/* Please INDENT in Linux by running indent utility on src_file_name */</p>
<p>/************************************NOTIFY.c ******************************************************************</p>
<p> This File               : notify.c </p>
<p> Programmer              : Nagesh Nanjundachari at garden.nagesh@gmail.com </p>
<p> </p>
<p> This programme is just to demonstrate how POSIX-MQ with ONE-message exchanged without SemaPhores.</p>
<p> Execute this  notify.c  programme first.</p>
<p> This process receives message(ODDN or EVEN) sent by random.c  and then it acknowledges number(11111 or 22222).  </p>
<p> USAGE: cc notify.c -lrt -o notify ; ./notify    in  first virtual-terminal</p>
<p>         </p>
<p>****************************NOTIFY.c****************************************************************************/</p>
<p></p>
<p>/* EXECUTE THIS PROGRAMME notify.c BEFORE RUNNING random.c in a new  Terminal session */</p>
<p>#include&ltstdio.h&gt</p>
<p>#include&ltstdlib.h&gt</p>
<p>#include&ltstring.h&gt</p>
<p>#include&ltunistd.h&gt</p>
<p>#include&ltfcntl.h&gt</p>
<p>#include&ltsys/stat.h&gt</p>
<p>#include&ltmqueue.h&gt</p>
<p>#include&lterrno.h&gt</p>
<p>#include&ltsignal.h&gt</p>
<p></p>
<p>#define BUFF_LEN     6</p>
<p></p>
<p>char rx_data[BUFF_LEN];</p>
<p>char tx_data[BUFF_LEN];</p>
<p></p>
<p>main (int argc, char **argv)</p>
<p>{</p>
<p></p>
<p>  mqd_t mq_id;</p>
<p>  pid_t pid_as_priority;</p>
<p>  struct mq_attr org_attr, present_attr;</p>
<p></p>
<p>  org_attr.mq_flags = 0;</p>
<p>  org_attr.mq_maxmsg = 1;</p>
<p>  org_attr.mq_msgsize = BUFF_LEN-1;</p>
<p>  org_attr.mq_curmsgs = 0;</p>
<p></p>
<p>  mq_id = mq_unlink ("/MQ_NN");</p>
<p>  mq_id = mq_open ("/MQ_NN", O_CREAT | O_RDWR, 00777, &org_attr);</p>
<p>  if (mq_id < 0)</p>
<p>    perror ("mq_open");</p>
<p></p>
<p>  fprintf (stdout, "Notify proc is ready\n");</p>
<p></p>
<p>  while (1)</p>
<p>  {</p>
<p>        /* receive message from random.c process */</p>
<p>      if (mq_receive (mq_id, rx_data, BUFF_LEN, &pid_as_priority) < 0)</p>
<p>        perror ("mq_receive");</p>
<p>      else</p>
<p>        {</p>
<p>          /* print data exchange  on stdout. */</p>
<p>          fprintf (stdout, "MSG RECEIVED FROM RANDOM.C PROC: %s\n", rx_data);</p>
<p></p>
<p>          /* Make acknowledegment number based on received msg. */</p>
<p>          if (strstr (rx_data, "ODDN") != NULL)</p>
<p>            strcpy (tx_data, "1111");</p>
<p>          if (strstr (rx_data, "EVEN") != NULL)</p>
<p>            strcpy (tx_data, "2222");</p>
<p></p>
<p>          /* Put acknowledgement-number on MQ so that random.c process reads. */</p>
<p>          mq_send (mq_id, tx_data, sizeof (tx_data) - 1, 0);</p>
<p></p>
<p>          /* Make sure that the message is on MQ and then notify random process. */</p>
<p>          while (!present_attr.mq_curmsgs)</p>
<p>            mq_getattr (mq_id, &present_attr);</p>
<p></p>
<p>          /* Notify that Acknowledge is sent to random proc. */</p>
<p>          kill (pid_as_priority, SIGUSR1);</p>
<p></p>
<p>          /* wait for zero message on MQ so that read next new message sent by random proc. */</p>
<p>          while (present_attr.mq_curmsgs)</p>
<p>            mq_getattr (mq_id, &present_attr);</p>
<p>        }</p>
<p>  }</p>
<p>}</p>
<p></p>
<p></p>
<p></p>
<p></p>
<p>/************************************RANDOM.c in another new  Terminal session******************************************************************</p>
<p> This File               : random.c </p>
<p> Programmer              : Nagesh Nanjundachari at garden.nagesh@gmail.com </p>
<p> </p>
<p> This programme is just to demonstrate how POSIX-MQ with ONE-message exchanged without SemaPhores.</p>
<p> Execute this  notify.c  programme first.</p>
<p> This process receives message(ODDN or EVEN) sent by random.c  and then it acknowledges number(11111 or 22222).  </p>
<p> USAGE: cc random.c -lrt -o random ; ./random   in another new terminal session </p>
<p>        </p>
<p>************************RANDOM.c in another new  Terminal session*************************************************************/</p>
<p></p>
<p>/* EXECUTE THIS random.c PROGRAMME AFTER RUNNING notify.c */</p>
<p>#include&ltstdio.h&gt</p>
<p>#include&ltstdlib.h&gt</p>
<p>#include&ltstring.h&gt</p>
<p>#include&ltunistd.h&gt</p>
<p>#include&ltfcntl.h&gt</p>
<p>#include&ltsys/stat.h&gt</p>
<p>#include&ltmqueue.h&gt</p>
<p>#include&lterrno.h&gt</p>
<p>#include&ltsignal.h&gt</p>
<p></p>
<p>#define BUFF_LEN     6</p>
<p></p>
<p>char tx_data[BUFF_LEN];</p>
<p>char rx_data[BUFF_LEN];</p>
<p>struct sigaction mq_notif;</p>
<p>volatile int ack_recvd = 1;</p>
<p>mqd_t mq_id;</p>
<p></p>
<p></p>
<p>void msg_arrived (int sig)</p>
<p>{</p>
<p></p>
<p>  if (mq_receive (mq_id, rx_data, BUFF_LEN, NULL) < 0)</p>
<p>    perror ("mq_recv");</p>
<p>  ack_recvd = 1;</p>
<p>  fprintf (stdout, "ACK MSG RECVD: %s\n", rx_data);</p>
<p>}</p>
<p></p>
<p>main (int argc, char **argv)</p>
<p>{</p>
<p></p>
<p>  unsigned int pid_as_priority = 0;</p>
<p>  struct mq_attr present_attr;</p>
<p></p>
<p></p>
<p>  pid_as_priority = getpid ();</p>
<p></p>
<p>  mq_id = mq_open ("/MQ_NN", O_RDWR);</p>
<p>  if (mq_id < 0)</p>
<p>    {</p>
<p>      perror ("mq_open");</p>
<p>      exit (1);</p>
<p>    }</p>
<p>  /* Register for message arrival notification. */</p>
<p>  mq_notif.sa_handler = &msg_arrived;</p>
<p>  sigaction (SIGUSR1, &mq_notif, NULL);</p>
<p></p>
<p>  fprintf (stdout, "random proc will send 2 sec delayed msg. \n");</p>
<p></p>
<p>  while (1)</p>
<p>    {</p>
<p>      /* random event generator. and make message string. */</p>
<p>      if (random () % 2)</p>
<p>        strcpy (tx_data, "ODDN");</p>
<p>      else</p>
<p>        strcpy (tx_data, "EVEN");</p>
<p></p>
<p>      /* Send message 2 sec delay. */</p>
<p>      sleep (2);</p>
<p></p>
<p>      /* Wait for no messages on MQ before putting message on MQ. */</p>
<p>      while (present_attr.mq_curmsgs) mq_getattr (mq_id, &present_attr);</p>
<p>      if (mq_send (mq_id, tx_data, sizeof (tx_data) - 1, pid_as_priority) < 0)</p>
<p>        perror ("mq_send");</p>
<p>      ack_recvd = 0;</p>
<p>      while (!ack_recvd);</p>
<p>    }</p>
<p>}</p>

